import org.json.JSONArray;
import org.json.JSONObject;
import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());
        JSONObject result = new JSONObject();
        String objectName = "";

        for (String line : lines) {
            String[] arr = line.split(",");
            if (arr.length > 2 && !arr[2].isEmpty()) {
                objectName = arr[2].trim();
                result.put(objectName, new JSONObject());
            } else if (arr.length > 3 && !arr[3].isEmpty()) {
                String sectionName = arr[3].trim();
                JSONObject sectionObject = new JSONObject();

                JSONArray metricsArray = new JSONArray();
                for (int i = 4; i + 4 < arr.length; i += 5) {
                    JSONObject metricObject = new JSONObject();
                    metricObject.put("MetricName", arr[i].trim());
                    metricObject.put("Min", arr[i + 1].trim());
                    metricObject.put("Average", arr[i + 2].trim());
                    metricObject.put("Max", arr[i + 3].trim());
                    metricObject.put("CumulativeCounterValue", arr[i + 4].trim());
                    metricsArray.put(metricObject);
                }

                sectionObject.put("Metrics", metricsArray);
                result.getJSONObject(objectName).put(sectionName, sectionObject);
            }
        }

        collector.collect(result.toString());
    }
}
