import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import com.google.gson.JsonObject;
import com.google.gson.JsonArray;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    private JsonObject currentObject;
    private String currentObjectName;
    private Collector<String> collector;

    @Override
    public void flatMap(String input, Collector<String> collector) {
        this.collector = collector;
        String[] columns = input.split("\\s+");

        if (columns.length > 1 && !columns[1].isEmpty()) {
            // New object found
            collectCurrentObject();
            currentObjectName = columns[1];
            currentObject = new JsonObject();
            currentObject.addProperty("ObjectName", currentObjectName);
        } else if (columns.length > 2 && !columns[2].isEmpty()) {
            // Metrics row found
            JsonObject metricsObject = new JsonObject();
            metricsObject.addProperty("Min", columns[3]);
            metricsObject.addProperty("Average", columns[4]);
            metricsObject.addProperty("Max", columns[5]);
            metricsObject.addProperty("CumulativeCounterValue", columns[6]);

            String metricName = columns[2].replaceAll("\\s+", "");
            currentObject.add(metricName, metricsObject);
        }
    }

    @Override
    public void close() {
        collectCurrentObject();
    }

    private void collectCurrentObject() {
        if (currentObject != null) {
            collector.collect(currentObject.toString());
            currentObject = null;
        }
    }
}
