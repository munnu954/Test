import java.util.Stack;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());
        Stack<JsonObject> objectStack = new Stack<>();

        for (String line : lines) {
            String[] arr = line.split(",");

            if (arr.length > 0 && arr[0].equals("ObjectName")) {
                // New object begins
                JsonObject currentObject = new JsonObject();
                currentObject.addProperty("ObjectName", arr[1]);
                objectStack.push(currentObject);
            } else if (!objectStack.isEmpty()) {
                // Sub-object details
                JsonObject currentObject = objectStack.peek();
                String fieldName = arr[0];
                JsonObject subObject = new JsonObject();

                for (int i = 1; i < arr.length; i += 4) {
                    String min = arr[i + 2].equals("-") ? "" : arr[i + 2];
                    String avg = arr[i + 1].equals("-") ? "" : arr[i + 1];
                    String max = arr[i].equals("-") ? "" : arr[i];
                    String cumulativeCounterValue = arr[i + 3];

                    JsonObject subObjectDetails = new JsonObject();
                    subObjectDetails.addProperty("Min", min);
                    subObjectDetails.addProperty("Average", avg);
                    subObjectDetails.addProperty("Max", max);
                    subObjectDetails.addProperty("Cumulative counter value", cumulativeCounterValue);

                    subObject.add(arr[i + 4], subObjectDetails);
                }

                currentObject.add(fieldName, subObject);
            }
        }

        // Collect the top-level objects
        while (!objectStack.isEmpty()) {
            collector.collect(objectStack.pop().toString());
        }
    }
}
