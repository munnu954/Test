@SpringBootTest
@ExtendWith(MockitoExtension.class)
class FlinkApiControllerTest {

    @Mock
    private RestTemplate restTemplate;
    
    @Mock
    private KafkaInputProducer kafkaInputProducer;
    
    @Mock
    private KafkaConsumer kafkaConsumer;

    @InjectMocks
    private FlinkApiController flinkApiController;

    // AC1: Jar file is not uploaded to flink cluster
    @Test
    void testJarFileNotUploadedToFlinkCluster() {
        given(restTemplate.postForEntity(anyString(), any(), eq(String.class)))
                .willReturn(new ResponseEntity<>("", HttpStatus.INTERNAL_SERVER_ERROR));

        String result = flinkApiController.triggerJob(new SpaceCollector(), ".csv");

        assertEquals("Job is not triggered", result);
        
        verify(kafkaConsumer, times(1)).writeLogToFile(eq(metadata), eq(destinationFolderPath));
        verify(kafkaInputProducer, times(1)).sendFailureMessage(any(), any(), any());
    }

    // AC2: Non existent jar id passed to flink cluster
    @Test
    void testNonExistentJarIdPassedToFlinkCluster() {
        given(restTemplate.postForEntity(anyString(), any(), eq(String.class)))
                .willThrow(new HttpClientErrorException(HttpStatus.NOT_FOUND));

        String result = flinkApiController.triggerJob(new SpaceCollector(), ".csv");

        assertEquals("Job is not triggered", result);
        
        verify(kafkaConsumer, times(1)).writeLogToFile(eq(metadata), eq(destinationFolderPath));
        verify(kafkaInputProducer, times(1)).sendFailureMessage(any(), any(), any());
    }
}