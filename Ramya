import com.jcraft.jsch.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class SSHServiceTest {

    @InjectMocks
    private SSHService sshService;

    @Mock
    private CollectorUtil collectorUtil;

    @Mock
    private DateUtil dateUtil;

    @Mock
    private LuceneCollectionAuditRepository luceneCollectionAuditRepo;

    @Mock
    private JSchFactory jschFactory;

    @Mock
    private OutputStreamCreator outputStreamCreator;

    @Mock
    private KafkaProducerService kafkaProducerService;

    @Mock
    private S3Service s3Service;

    @Mock
    private JSch jsch;

    @Mock
    private Session session;

    @Mock
    private ChannelSftp channelSftp;

    private SpaceCollector sp;
    private String dateReceived;
    private String auditTopic;

    @BeforeEach
    void setUp() throws Exception {
        sp = new SpaceCollector();
        sp.setUserName("user");
        sp.setUrl("host");
        sp.setPassword("password");
        sp.setPort(22);
        sp.setInputFilePath("/remote/path");
        sp.setOutputFilePath("/local/path");

        dateReceived = "2023-01-01";
        auditTopic = "audit-topic";

        when(jschFactory.createJSch()).thenReturn(jsch);
        when(jsch.getSession(anyString(), anyString(), anyInt())).thenReturn(session);
        when(session.openChannel("sftp")).thenReturn(channelSftp);
        doNothing().when(session).connect();
        doNothing().when(channelSftp).connect();
        doNothing().when(channelSftp).disconnect();
        doNothing().when(session).disconnect();
    }

    @Test
    void retrieveData_success() throws Exception {
        when(FileUtil.getDirectory(sp.getInputFilePath())).thenReturn("/remote/path");
        when(FileUtil.getDirectory(sp.getOutputFilePath())).thenReturn("/local/path");
        when(channelSftp.ls(anyString())).thenReturn(new Vector<>());

        boolean result = sshService.retrieveData(sp, dateReceived, auditTopic);

        assertTrue(result);
        verify(session).connect();
        verify(channelSftp).connect();
        verify(channelSftp).disconnect();
        verify(session).disconnect();
    }

    @Test
    void retrieveData_failure() throws Exception {
        when(FileUtil.getDirectory(sp.getInputFilePath())).thenReturn("/remote/path");
        when(FileUtil.getDirectory(sp.getOutputFilePath())).thenReturn("/local/path");
        doThrow(new SftpException(ChannelSftp.SSH_FX_FAILURE, "failure")).when(channelSftp).ls(anyString());

        assertThrows(Exception.class, () -> sshService.retrieveData(sp, dateReceived, auditTopic));
        verify(session).disconnect();
    }

    @Test
    void createAuditObject() {
        String auditInputFilePath = "/remote/path/file.txt";
        String auditJobStatus = "SUCCESS";
        String auditExceptions = "";

        CollectionAudit audit = sshService.createAuditObject(sp, auditInputFilePath, auditJobStatus, auditExceptions);

        assertNotNull(audit);
        assertEquals(auditInputFilePath, audit.getInputFilePath());
        assertEquals(auditJobStatus, audit.getJobStatus());
        assertEquals(auditExceptions, audit.getExceptions());
    }

    @Test
    void getAuditStatusMap() {
        Vector<ChannelSftp.LsEntry> files = new Vector<>();
        ChannelSftp.LsEntry file = mock(ChannelSftp.LsEntry.class);
        files.add(file);

        List<CollectionAudit> audits = new ArrayList<>();
        CollectionAudit audit = new CollectionAudit();
        audit.setInputFilePath("/remote/path/file.txt");
        audit.setJobStatus("SUCCESS");
        audits.add(audit);

        when(file.getAttrs()).thenReturn(mock(SftpATTRS.class));
        when(file.getAttrs().isDir()).thenReturn(false);
        when(file.getFilename()).thenReturn("file.txt");
        when(luceneCollectionAuditRepo.findLatestByFilePaths(anyList())).thenReturn(audits);

        Map<String, String> auditStatusMap = sshService.getAuditStatusMap(files, "/remote/path");

        assertNotNull(auditStatusMap);
        assertEquals("SUCCESS", auditStatusMap.get("/remote/path/file.txt"));
    }

    @Test
    void partitionList() {
        List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
        List<List<Integer>> partitions = sshService.partitionList(list, 2);

        assertEquals(3, partitions.size());
        assertEquals(Arrays.asList(1, 2), partitions.get(0));
        assertEquals(Arrays.asList(3, 4), partitions.get(1));
        assertEquals(Collections.singletonList(5), partitions.get(2));
    }

    @Test
    void getJsch() throws JSchException {
        when(jschFactory.createJSch()).thenReturn(jsch);

        JSch result = sshService.getJsch("host", "password");

        assertNotNull(result);
        verify(jsch).addIdentity("/prod/eclapp/lib/id_rsa_decoded");
        verify(jsch).setKnownHosts(System.getProperty("user.home") + SSHService.SSH_KNOWN_HOSTS);
    }

    @Test
    void getSession() throws JSchException {
        when(jsch.getSession(anyString(), anyString(), anyInt())).thenReturn(session);

        Session result = sshService.getSession("user", "host", "password", 22, jsch);

        assertNotNull(result);
        verify(jsch).getSession("user", "host", 22);
        verify(session).setPassword("password");
        verify(session).setConfig("StrictHostKeyChecking", "no");
    }

    @Test
    void getChannelSftp() throws JSchException, SftpException {
        when(session.openChannel("sftp")).thenReturn(channelSftp);
        doNothing().when(channelSftp).cd(anyString());

        ChannelSftp result = sshService.getChannelSftp(session, "/remote/path");

        assertNotNull(result);
        verify(session).openChannel("sftp");
        verify(channelSftp).cd("/remote/path");
    }

    @Test
    void retrieveAttributesOfRemoteFile() throws SftpException {
        ChannelSftp.LsEntry file = mock(ChannelSftp.LsEntry.class);
        when(file.getFilename()).thenReturn("file.txt");
        doNothing().when(channelSftp).stat(anyString());

        sshService.retrieveAttributesOfRemoteFile(channelSftp, file, "/remote/path", "/remote/path/file.txt");

        verify(channelSftp).stat("file.txt");
    }

    @Test
    void retrieveAttributesOfRemoteFile_nonExistentFile() throws SftpException {
        ChannelSftp.LsEntry file = mock(ChannelSftp.LsEntry.class);
        when(file.getFilename()).thenReturn("file.txt");
        doThrow(new SftpException(ChannelSftp.SSH_FX_NO_SUCH_FILE, "no such file")).when(channelSftp).stat(anyString());

        Exception exception = assertThrows(SftpException.class, () -> sshService.retrieveAttributesOfRemoteFile(channelSftp, file, "/remote/path", "/remote/path/file.txt"));
        assertEquals(ChannelSftp.SSH_FX_NO_SUCH_FILE, ((SftpException) exception).id);
    }
}
