import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());
        String objectName = "";
        String beginDate = "";
        String endDate = "";
        String ticketNumber = "";
        JsonObject result = new JsonObject();

        for (int i = 1; i < lines.length; i++) {
            String[] arr = lines[i].split(",");

            if (arr.length > 2 && !arr[2].isEmpty()) {
                objectName = arr[2].trim();
                beginDate = lines[i + 1].split(",")[1].trim();
                endDate = lines[i + 2].split(",")[1].trim();
                ticketNumber = lines[i + 3].split(",")[1].trim();
            } else if (arr.length > 0 && !arr[0].isEmpty()) {
                String sectionName = arr[0].trim();
                JsonObject sectionObject = new JsonObject();

                sectionObject.addProperty("Min", arr[3].trim());
                sectionObject.addProperty("Average", arr[4].trim());
                sectionObject.addProperty("Max", arr[5].trim());
                sectionObject.addProperty("Cumulative Counter Value", arr[6].trim());

                result.addProperty("ObjectName", objectName);
                result.addProperty("Begin Date", beginDate);
                result.addProperty("End Date", endDate);
                result.addProperty("Ticket Number", ticketNumber);
                result.add(sectionName, sectionObject);
            }
        }

        collector.collect(result.toString());
    }
}
