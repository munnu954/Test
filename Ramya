import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());
        String objectName = "";
        JSONObject result = new JSONObject();
        JSONObject objectDetails = new JSONObject();
        JSONArray sections = new JSONArray();

        for (int i = 1; i < lines.length; i++) {
            String[] arr = lines[i].split(",");

            if (arr.length > 2 && !arr[2].isEmpty()) {
                // This is the line containing ObjectName
                objectName = arr[2].trim();

                // Extract details from the lines below ObjectName
                if (i + 3 < lines.length) {
                    objectDetails.put("Begin Date", lines[i + 1].split(",")[1].trim());
                    objectDetails.put("End Date", lines[i + 2].split(",")[1].trim());
                    objectDetails.put("Ticket Number", lines[i + 3].split(",")[1].trim());
                }
            } else if (arr.length > 0 && !arr[0].isEmpty() && !arr[0].equals("TICKET NUMBER")) {
                // This is a line containing SectionName, skip rows with "TICKET NUMBER"
                String sectionName = arr[0].trim();
                JSONObject sectionObject = new JSONObject();

                // Extract details for the section
                if (arr.length > 3) {
                    sectionObject.put("Min", arr[3].trim());
                    sectionObject.put("Average", arr[4].trim());
                    sectionObject.put("Max", arr[5].trim());
                    sectionObject.put("Cumulative Counter Value", arr[6].trim());
                }

                // Add section to sections
                sections.add(sectionObject);
            }
        }

        // Add the final JSON structure to result
        result.put("ObjectName", objectName);
        result.put("Details", objectDetails);
        result.put("Sections", sections);

        collector.collect(result.toJSONString());
    }
}
