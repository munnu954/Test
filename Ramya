import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import org.json.JSONObject;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    private JSONObject currentObject;
    private Collector<String> collector;

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        this.collector = collector;
        String[] arr = input.split(",");

        if (arr.length > 2 && arr[2] != null && !arr[2].isEmpty()) {
            // New main object
            if (currentObject != null) {
                // Save the completed object
                collector.collect(currentObject.toString());
            }
            currentObject = new JSONObject();
            currentObject.put("ObjectName", arr[2].trim());
        } else if (currentObject != null) {
            processObjectDetails(arr);
        }
    }

    private void processObjectDetails(String[] arr) {
        // Dynamic handling of columns and values
        for (int i = 0; i < arr.length; i++) {
            if (i % 2 == 0 && i + 1 < arr.length && arr[i] != null && arr[i + 1] != null && !arr[i].isEmpty()) {
                // Even index contains column names, odd index contains values
                String columnName = arr[i].trim();
                String value = arr[i + 1].trim();
                currentObject.put(columnName, value);
            }
        }
    }

    @Override
    public void close() {
        if (currentObject != null) {
            // Save the completed object
            collector.collect(currentObject.toString());
        }
    }
}
