import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;

import com.google.gson.JsonObject;

public class CsvtoJsonTonesTransformer implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] rows = input.split(";");

        if (rows.length < 5) {
            // Invalid row, skip processing
            System.out.println("Invalid row: " + input);
            return;
        }

        JsonObject json = new JsonObject();
        String objectName = rows[4].trim();

        json.addProperty("ObjectName", objectName);

        for (int i = 5; i < rows.length; i += 5) {
            String key = rows[i].trim();
            String min = rows[i + 1].trim();
            String avg = rows[i + 2].trim();
            String max = rows[i + 3].trim();
            String cumulative = rows[i + 4].trim();

            JsonObject subObject = new JsonObject();
            subObject.addProperty("Min", min);
            subObject.addProperty("Average", avg);
            subObject.addProperty("Max", max);
            subObject.addProperty("Cumulative counter value", cumulative);

            json.add(key, subObject);
        }

        String result = json.toString();
        System.out.println("Transformed JSON: " + result);
        collector.collect(result);
    }
}
