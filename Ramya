import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import org.json.JSONObject;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    private JSONObject jsonObject;

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] values = input.split(",");

        if (values.length == 1) {
            // Main Object Name
            handleMainObject(values[0]);
        } else {
            // Sub-object details
            handleSubObject(values);
        }

        collector.collect(jsonObject.toString());
    }

    private void handleMainObject(String mainObjectName) {
        if (jsonObject != null) {
            collector.collect(jsonObject.toString());
        }
        jsonObject = new JSONObject();
        jsonObject.put("ObjectName", mainObjectName.trim());
    }

    private void handleSubObject(String[] values) {
        String subObjectName = values[0].trim();
        JSONObject subObject = new JSONObject();
        subObject.put("Min", values[1].trim());
        subObject.put("Average", values[2].trim());
        subObject.put("Max", values[3].trim());
        subObject.put("CumulativeCounterValue", values[4].trim());

        jsonObject.put(subObjectName, subObject);
    }
}
