import com.google.gson.JsonObject;
import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());
        JsonObject result = new JsonObject();
        String objectName = "";
        JsonObject sectionObject = null;

        for (String line : lines) {
            String[] arr = line.split(",");

            if (arr.length > 2 && !arr[2].isEmpty()) {
                // New object name found
                objectName = arr[2].trim();
                sectionObject = new JsonObject();
            } else if (arr.length > 3 && !arr[3].isEmpty()) {
                // Section name found
                String sectionName = arr[3].trim();

                // Check if sectionObject is not null (handles sections without metrics)
                if (sectionObject != null) {
                    JsonObject metricObject = new JsonObject();
                    metricObject.addProperty("Min", arr[4].trim());
                    metricObject.addProperty("Average", arr[5].trim());
                    metricObject.addProperty("Max", arr[6].trim());
                    metricObject.addProperty("Cumulative Counter Value", arr[7].trim());
                    sectionObject.add(sectionName, metricObject);
                }
            }
        }

        // Check if objectName is not empty (handles cases where the file ends without a section)
        if (!objectName.isEmpty()) {
            result.add(objectName, sectionObject);
        }

        collector.collect(result.toString());
    }
}
