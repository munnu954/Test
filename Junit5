@ExtendWith(MockitoExtension.class)
class AlarmRepositoryImplTest {

    @InjectMocks
    private AlarmRepositoryImpl alarmRepositoryImpl;

    @Mock
    private JdbcTemplate jdbcTemplate;

    @Mock
    private AlarmPostingUtils utils;

    @Mock
    private PostGreDataBaseConfig postgresConf;

    @Mock
    private PostingRuleProcessingService postingRuleProcessingService;

    private Alarm alarm;

    @BeforeEach
    void setup() {
        alarm = new Alarm();
        alarm.setAlarmIdentity("12345");
        alarm.setAlarmUpdatedTime("2023-04-01T12:00:00Z");
        alarm.setSequenceID(100L);
    }

    @Test
    void testPostAlarmForEachIteration_PerceivedSeverityAndStateUpdated_WhenStateIsCleared() {
        // Arrange
        String dbAlmUpdatedTime = "2023-04-01T11:59:59Z";
        SqlRowSet rs = Mockito.mock(SqlRowSet.class);
        when(jdbcTemplate.queryForRowSet(anyString(), any())).thenReturn(rs);
        when(rs.next()).thenReturn(true);
        when(rs.getTimestamp("alarmupdatedtime")).thenReturn(Timestamp.from(Instant.parse(dbAlmUpdatedTime)));
        when(rs.getLong("sequenceid")).thenReturn(100L);
        when(rs.getInt("state")).thenReturn(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateCleared()));
        when(rs.getInt("perceivedseverity")).thenReturn(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityIndeterminate()));
        alarm.setPerceivedSeverity(-1);
        alarm.setState(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateCleared()));

        // Act
        int rowsAffected = alarmRepositoryImpl.postAlarmForEachIteration(alarm, "comp-id");

        // Assert
        assertEquals(1, rowsAffected);
        assertEquals(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityIndeterminate()), alarm.getPerceivedSeverity());
    }

    @Test
    void testPostAlarmForEachIteration_PerceivedSeverityAndStateNotUpdated_WhenStateIsNotCleared() {
        // Arrange
        String dbAlmUpdatedTime = "2023-04-01T11:59:59Z";
        SqlRowSet rs = Mockito.mock(SqlRowSet.class);
        when(jdbcTemplate.queryForRowSet(anyString(), any())).thenReturn(rs);
        when(rs.next()).thenReturn(true);
        when(rs.getTimestamp("alarmupdatedtime")).thenReturn(Timestamp.from(Instant.parse(dbAlmUpdatedTime)));
        when(rs.getLong("sequenceid")).thenReturn(100L);
        when(rs.getInt("state")).thenReturn(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateUnclorrelated()));
        when(rs.getInt("perceivedseverity")).thenReturn(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityIndeterminate()));
        alarm.setPerceivedSeverity(-1);
        alarm.setState(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()));

        // Act
        int rowsAffected = alarmRepositoryImpl.postAlarmForEachIteration(alarm, "comp-id");

        // Assert
        assertEquals(1, rowsAffected);
        assertEquals(-1, alarm.getPerceivedSeverity());
        assertEquals(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()), alarm.getState());
    }
}