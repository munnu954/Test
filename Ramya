import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import com.google.gson.JsonObject;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] lines = input.split(System.lineSeparator());

        JsonObject result = null;
        JsonObject objectDetails = null;

        // Extract details from the lines below ObjectName
        int i = 0;
        while (i < lines.length) {
            String[] arr = lines[i].split(",");

            if (arr.length > 2 && !arr[2].isEmpty()) {
                // This is the line containing ObjectName
                if (result != null) {
                    // Collect the previous result
                    collector.collect(result.toString());
                }

                result = new JsonObject();
                objectDetails = new JsonObject();

                String objectName = arr[2].trim();

                // Extract details from the lines below ObjectName
                if (i + 3 < lines.length) {
                    objectDetails.addProperty("Begin Date", getProperty(lines, i + 1, 1));
                    objectDetails.addProperty("End Date", getProperty(lines, i + 2, 1));
                    objectDetails.addProperty("Ticket Number", getProperty(lines, i + 3, 1));
                }

                result.addProperty("ObjectName", objectName);
                result.add("ObjectDetails", objectDetails);

                // Continue processing the sections inside the loop
                int j = i + 4; // Set initial value for j
                while (j < lines.length && !lines[j].startsWith(",")) {
                    String[] sectionArr = lines[j].split(",");
                    if (sectionArr.length > 0 && !sectionArr[0].isEmpty()) {
                        // This is a line containing SectionName, skip rows with "TICKET NUMBER"
                        String sectionName = sectionArr[0].trim();
                        JsonObject sectionObject = new JsonObject();

                        // Extract details for the section
                        int sectionLength = Math.min(sectionArr.length, 7); // Limit the section length
                        for (int k = 3; k < sectionLength; k++) {
                            sectionObject.addProperty(getPropertyName(sectionArr, k), getProperty(sectionArr, k));
                        }

                        // Add section to objectDetails
                        objectDetails.add(sectionName, sectionObject);
                    }
                    j++;
                }
            }

            i++;
        }

        // Collect the last result
        if (result != null) {
            collector.collect(result.toString());
        }
    }

    private String getProperty(String[] arr, int index) {
        return (index < arr.length) ? arr[index].trim() : "";
    }

    private String getProperty(String[] lines, int lineIndex, int colIndex) {
        String[] lineArr = lines[lineIndex].split(",");
        return (colIndex < lineArr.length) ? lineArr[colIndex].trim() : "";
    }

    private String getPropertyName(String[] arr, int index) {
        return (index < arr.length) ? arr[index].trim().replace(" ", "_") : "";
    }
}
