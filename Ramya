Feature: Retrieve and process files from a remote server

  Background:
    Given a SpaceCollector with the following details
      | username    | url        | password | port | inputFilePath    | outputFilePath   |
      | user        | host       | pass     | 22   | /remote/path     | /local/path      |
    And the current date is "2023-01-01"
    And the audit topic is "audit-topic"

  Scenario: Successfully retrieve and process files including nested directories and files
    Given the remote directory "/remote/path" contains the following files
      | filename         | isDir |
      | Sample1.csv      | false |
      | nested           | true  |
    And the nested directory "/remote/path/nested" contains the following files
      | filename         | isDir |
      | Sample2.csv      | false |
    When the data retriever retrieves data
    Then the following local files should be created
      | filename               |
      | /local/path/Sample1.csv |
      | /local/path/nested/Sample2.csv |
    And the following messages should be sent to Kafka
      | key                                           | status                  |
      | profile/fileType/host/01-01-2023/Sample1.csv  | COLLECTION_SUCCESSFUL   |
      | profile/fileType/host/01-01-2023/nested/Sample2.csv | COLLECTION_SUCCESSFUL   |

  Scenario: Successfully process a nested ZIP file
    Given the remote directory "/remote/path" contains the following files
      | filename         | isDir |
      | Sample.zip       | false |
    And the ZIP file "/remote/path/Sample.zip" contains the following files
      | filename         |
      | nested/Sample2.csv |
    When the data retriever retrieves data
    Then the following local files should be created
      | filename               |
      | /local/path/Sample.zip |
      | /local/path/Sample/nested/Sample2.csv |
    And the following messages should be sent to Kafka
      | key                                           | status                  |
      | profile/fileType/host/01-01-2023/Sample.zip   | COLLECTION_SUCCESSFUL   |
      | profile/fileType/host/01-01-2023/Sample/nested/Sample2.csv | COLLECTION_SUCCESSFUL   |
