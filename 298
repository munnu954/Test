import org.junit.jupiter.api.Test;
import java.lang.reflect.Method;
import java.util.Set;
import java.util.Arrays;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class AlarmRepositoryImplTest {

    @Test
    public void mergeArrayMethod_withTagFromDbAndAlarm_shouldConvertTagToStringArrayAndAddTagsToSet() throws Exception {
        AlarmRepositoryImpl alarmRepositoryImpl = new AlarmRepositoryImpl();

        String[] expectedTagArray = {"tag1", "tag2"};

        SerialArray mockSerialArray = mock(SerialArray.class);
        Alarm mockAlarm = mock(Alarm.class);

        when(mockSerialArray.getArray()).thenReturn(expectedTagArray);
        when(mockAlarm.getTag()).thenReturn(expectedTagArray);

        Method mergeArrayMethod = AlarmRepositoryImpl.class.getDeclaredMethod("mergeArrayMethod", Object.class, Alarm.class);
        mergeArrayMethod.setAccessible(true);

        Set<String> actualTags = (Set<String>) mergeArrayMethod.invoke(alarmRepositoryImpl, mockSerialArray, mockAlarm);

        Method convertTagToStringArrayMethod = AlarmRepositoryImpl.class.getDeclaredMethod("convertTagToStringArray", Object.class);
        convertTagToStringArrayMethod.setAccessible(true);
        verify(mockSerialArray, times(1)).getArray();
        verify(alarmRepositoryImpl, times(1)).convertTagToStringArray(mockSerialArray);

        Method addTagsToSetMethod = AlarmRepositoryImpl.class.getDeclaredMethod("addTagsToSet", String[].class);
        addTagsToSetMethod.setAccessible(true);
        verify(alarmRepositoryImpl, times(1)).addTagsToSet(expectedTagArray);

        assertTrue(actualTags instanceof Set);
        assertEquals(expectedTagArray.length, actualTags.size());
        assertTrue(actualTags.containsAll(Arrays.asList(expectedTagArray)));
    }
}