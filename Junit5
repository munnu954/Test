import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)
class MessageReaderServiceTest {

    MessageReaderService messageReaderService;

    @Mock
    VMBParams vmbParams;

    @Mock
    ApolloServiceHealth healthChecker;

    @Mock
    RuleLoadingService ruleLoadingService;

    @BeforeEach
    void setup() {
        messageReaderService = new MessageReaderService();
        setMockValues();
    }

    private void setMockValues() {
        try {
            Field paramsField = MessageReaderService.class.getDeclaredField("params");
            paramsField.setAccessible(true);
            paramsField.set(messageReaderService, vmbParams);

            Field healthCheckerField = MessageReaderService.class.getDeclaredField("healthChecker");
            healthCheckerField.setAccessible(true);
            healthCheckerField.set(messageReaderService, healthChecker);

            Field rulesLoadingServiceField = MessageReaderService.class.getDeclaredField("rulesLoadingService");
            rulesLoadingServiceField.setAccessible(true);
            rulesLoadingServiceField.set(messageReaderService, ruleLoadingService);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            e.printStackTrace();
        }
    }

    @Test
    void testIntialializeMessageReaderService_ReaderNotNull() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Field readerField = MessageReaderService.class.getDeclaredField("reader");
        readerField.setAccessible(true);
        readerField.set(messageReaderService, mock(Reader.class));

        Method initializeMessageReaderServiceMethod = MessageReaderService.class.getDeclaredMethod("intialializeMessageReaderService");
        initializeMessageReaderServiceMethod.setAccessible(true);

        initializeMessageReaderServiceMethod.invoke(messageReaderService);

        assertNotNull(readerField.get(messageReaderService));
    }

    @Test
    void testIntialializeMessageReaderService_ReaderIsNull() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Field ruleUpdateNotifierVmbConfigField = MessageReaderService.class.getDeclaredField("ruleUpdateNotifierVmbConfig");
        ruleUpdateNotifierVmbConfigField.setAccessible(true);
        ruleUpdateNotifierVmbConfigField.set(messageReaderService, mock(VMBConfig.class));

        Method initializeMessageReaderServiceMethod = MessageReaderService.class.getDeclaredMethod("intialializeMessageReaderService");
        initializeMessageReaderServiceMethod.setAccessible(true);

        initializeMessageReaderServiceMethod.invoke(messageReaderService);

        assertNull(messageReaderService.reader);
    }
}
