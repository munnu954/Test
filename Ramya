import com.google.gson.JsonObject;
import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;

import java.util.HashMap;
import java.util.Map;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    private String currentSection = null;
    private Map<String, JsonObject> sections = new HashMap<>();

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] columns = input.split(",");
        String title = findTitle(columns);

        if (title != null) {
            currentSection = title;
            sections.put(currentSection, new JsonObject());
        }

        if (currentSection != null) {
            processRow(columns);
        }
    }

    private String findTitle(String[] columns) {
        for (String column : columns) {
            if (!column.trim().isEmpty()) {
                return column.trim();
            }
        }
        return null;
    }

    private void processRow(String[] columns) {
        JsonObject sectionObject = sections.get(currentSection);
        if (sectionObject != null) {
            if (columns.length > 1) {
                String attribute = columns[1].trim();
                String value = columns.length > 2 ? columns[2].trim() : "";

                if (!attribute.isEmpty()) {
                    sectionObject.addProperty(attribute, value);
                }
            }
        }
    }

    // Convert sections Map to JSON array
    private String convertToJson() {
        JsonObject result = new JsonObject();
        for (Map.Entry<String, JsonObject> entry : sections.entrySet()) {
            result.add(entry.getKey(), entry.getValue());
        }
        return result.toString();
    }

    @Override
    public void close() throws Exception {
        super.close();
        collector.collect(convertToJson());
    }
}
