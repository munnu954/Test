import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import org.json.JSONObject;

public class CsvtoJsonTonesTransformer implements FlatMapFunction<String, String> {
    private String[] headers;

    @Override
    public void flatMap(String s, Collector<String> collector) throws Exception {
        String[] values = s.split(",");

        if (headers == null) {
            headers = values;
            return;  // Skip processing the header row
        }

        JSONObject jsonObject = new JSONObject();
        for (int i = 0; i < values.length; i++) {
            String fieldName = headers[i].trim().replace("\"", "");

            String[] nestedKeys = fieldName.split("\\.");

            JSONObject currentContext = jsonObject;
            for (int j = 0; j < nestedKeys.length - 1; j++) {
                if (!currentContext.has(nestedKeys[j])) {
                    currentContext.put(nestedKeys[j], new JSONObject());
                }
                currentContext = currentContext.getJSONObject(nestedKeys[j]);
            }
            currentContext.put(nestedKeys[nestedKeys.length - 1], values[i].trim().replace("\"", ""));
        }

        collector.collect(jsonObject.toString());
    }
}