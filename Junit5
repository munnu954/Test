@ExtendWith(MockitoExtension.class)
class AlarmRepositoryImplTest {

    @InjectMocks
    private AlarmRepositoryImpl alarmRepositoryImpl;

    @Mock
    private JdbcTemplate jdbcTemplate;

    @Mock
    private AlarmPostingUtils utils;

    @Mock
    private PostGreDataBaseConfig postgresConf;

    @Mock
    private PostingRuleProcessingService postingRuleProcessingService;

    private Alarm alarm;

    @BeforeEach
    void setup() {
        alarm = new Alarm();
        alarm.setAlarmIdentity("12345");
        alarm.setAlarmUpdatedTime("2023-04-01T12:00:00Z");
        alarm.setSequenceID(100L);
    }

    @Test
    void testPostAlarmForEachIteration_ClearTimeUpdatedWhenStateIsCleared() {
        // Arrange
        String dbAlmUpdatedTime = "2023-04-01T11:59:59Z";
        SqlRowSet rs = Mockito.mock(SqlRowSet.class);
        when(jdbcTemplate.queryForRowSet(anyString(), any())).thenReturn(rs);
        when(rs.next()).thenReturn(true);
        when(rs.getTimestamp("alarmupdatedtime")).thenReturn(Timestamp.from(Instant.parse(dbAlmUpdatedTime)));
        when(rs.getLong("sequenceid")).thenReturn(100L);
        when(rs.getInt("state")).thenReturn(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateCleared()));
        when(rs.getInt("perceivedseverity")).thenReturn(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));
        alarm.setClearTime(null);
        alarm.setAlarmUpdatedTime("2023-04-01T11:59:59Z");
        alarm.setState(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateCleared()));
        alarm.setPerceivedSeverity(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));

        // Act
        int rowsAffected = alarmRepositoryImpl.postAlarmForEachIteration(alarm, "comp-id");

        // Assert
        assertEquals(1, rowsAffected);
        assertEquals("2023-04-01T11:59:59Z", alarm.getClearTime());
    }

    @Test
    void testPostAlarmForEachIteration_ClearTimeNotUpdated_WhenStateIsNotCleared() {
        // Arrange
        String dbAlmUpdatedTime = "2023-04-01T11:59:59Z";
        SqlRowSet rs = Mockito.mock(SqlRowSet.class);
        when(jdbcTemplate.queryForRowSet(anyString(), any())).thenReturn(rs);
        when(rs.next()).thenReturn(true);
        when(rs.getTimestamp("alarmupdatedtime")).thenReturn(Timestamp.from(Instant.parse(dbAlmUpdatedTime)));
        when(rs.getLong("sequenceid")).thenReturn(100L);
        when(rs.getInt("state")).thenReturn(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()));
        when(rs.getInt("perceivedseverity")).thenReturn(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));
        alarm.setClearTime(null);
        alarm.setAlarmUpdatedTime("2023-04-01T11:59:59Z");
        alarm.setState(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()));
        alarm.setPerceivedSeverity(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));

        // Act
        int rowsAffected = alarmRepositoryImpl.postAlarmForEachIteration(alarm, "comp-id");

        // Assert
        assertEquals(1, rowsAffected);
        assertNull(alarm.getClearTime());
    }

    @Test
    void testPostAlarmForEachIteration_ClearTimeNotUpdated_WhenPerceivedSeverityIsAny() {
        // Arrange
        String dbAlmUpdatedTime = "2023-04-01T11:59:59Z";
        SqlRowSet rs = Mockito.mock(SqlRowSet.class);
        when(jdbcTemplate.queryForRowSet(anyString(), any())).thenReturn(rs);
        when(rs.next()).thenReturn(true);
        when(rs.getTimestamp("alarmupdatedtime")).thenReturn(Timestamp.from(Instant.parse(dbAlmUpdatedTime)));
        when(rs.getLong("sequenceid")).thenReturn(100L);
        when(rs.getInt("state")).thenReturn(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()));
        when(rs.getInt("perceivedseverity")).thenReturn(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));
        alarm.setClearTime(null);
        alarm.setAlarmUpdatedTime("2023-04-01T11:59:59Z");
        alarm.setState(postgresConf.getAlarmStateMap().get(postgresConf.getAlarmStateNew()));
        alarm.setPerceivedSeverity(postgresConf.getPerceivedSeverityMap().get(postgresConf.getPerceivedSeverityAny()));

        // Act
        int rowsAffected = alarmRepositoryImpl.postAlarmForEachIteration(alarm, "comp-id");

        // Assert
        assertEquals(1, rowsAffected);
        assertNull(alarm.getClearTime());
    }

    // Add more test cases as needed to cover other scenarios
}