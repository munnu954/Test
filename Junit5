import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.concurrent.TimeUnit;

import org.apache.pulsar.client.api.Consumer;
import org.apache.pulsar.client.api.Message;
import org.apache.pulsar.client.api.PulsarClientException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)
class AlarmReceiverTest {

    private AlarmReceiver alarmReceiver;

    @Mock
    private VMBParams vmbParams;

    @Mock
    private AlarmPostGreService alarmPostGreService;

    @Mock
    private PostingService alarmPointLookupService;

    @BeforeEach
    void setUp() {
        alarmReceiver = new AlarmReceiver(vmbParams, alarmPostGreService, alarmPointLookupService);
    }

    @Test
    void testSyncReconnect() throws Exception {
        Field reconnectStage = AlarmReceiver.class.getDeclaredField("reconnectStage");
        reconnectStage.setAccessible(true);
        reconnectStage.set(null, 1);

        Method syncReconnect = AlarmReceiver.class.getDeclaredMethod("syncReconnect");
        syncReconnect.setAccessible(true);
        syncReconnect.invoke(alarmReceiver);

        assertEquals(2, (int) reconnectStage.get(null));
    }

    @Test
    void testStaticField() throws Exception {
        Field reconnectStage = AlarmReceiver.class.getDeclaredField("reconnectStage");
        reconnectStage.setAccessible(true);
        reconnectStage.set(null, 1);

        assertEquals(1, reconnectStage.get(null));
    }

    @Test
    void testShutDown() throws Exception {
        Consumer<byte[]> consumer = mock(Consumer.class);
        Field consumerField = AlarmReceiver.class.getDeclaredField("_consumer");
        consumerField.setAccessible(true);
        consumerField.set(alarmReceiver, consumer);

        Method shutDown = AlarmReceiver.class.getDeclaredMethod("shutDown");
        shutDown.setAccessible(true);
        shutDown.invoke(alarmReceiver);

        verify(consumer, times(1)).close();
    }

    @Test
    void testRun() throws Exception {
        Method receiveMessages = AlarmReceiver.class.getDeclaredMethod("receiveMessages");
        receiveMessages.setAccessible(true);
        receiveMessages.invoke(alarmReceiver);

        // Add more test cases as per the logic in the run() method
    }

    @Test
    void testHealth() {
        assertNotNull(alarmReceiver.health());
    }

    @Test
    void testGetConnection() throws Exception {
        Method getConnection = AlarmReceiver.class.getDeclaredMethod("getConnection");
        getConnection.setAccessible(true);
        getConnection.invoke(alarmReceiver);

        // Add assertions based on the behavior of getConnection()
    }

    @Test
    void testAcknowledgeMessage() throws Exception {
        Message<byte[]> message = mock(Message.class);
        Consumer<byte[]> consumer = mock(Consumer.class);

        Field consumerField = AlarmReceiver.class.getDeclaredField("_consumer");
        consumerField.setAccessible(true);
        consumerField.set(alarmReceiver, consumer);

        Method acknowledgeMessage = AlarmReceiver.class.getDeclaredMethod("acknowledgeMessage", Message.class);
        acknowledgeMessage.setAccessible(true);
        acknowledgeMessage.invoke(alarmReceiver, message);

        // Add assertions based on the behavior of acknowledgeMessage()
    }

}
``` 