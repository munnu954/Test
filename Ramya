public class CsvtoJsonConferenceCallTransformer implements FlatMapFunction<String, String> {

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] arr = input.split(",");

        // Assuming the CSV structure is fixed for the Conference-CallControl object
        JsonObject obj = new JsonObject();
        int currentIndex = 0;

        // Identify the main object name from column C
        String mainObjectName = arr[currentIndex++];
        obj.addProperty("ObjectName", mainObjectName);

        // Skip rows until you find the data rows
        while (currentIndex < arr.length && !arr[currentIndex].equals("BEGIN DATE")) {
            currentIndex++;
        }

        // Process data rows dynamically
        while (currentIndex < arr.length && arr[currentIndex].equals("BEGIN DATE")) {
            String subObjectName = arr[currentIndex].toLowerCase().replaceAll("\\s", "_");
            JsonObject subObject = new JsonObject();

            // Skip unnecessary rows
            currentIndex += 2;

            // Process Min, Average, Max, Cumulative counter value rows
            while (currentIndex < arr.length && !arr[currentIndex].isEmpty()) {
                String metricName = arr[currentIndex].toLowerCase().replaceAll("\\s", "_");
                subObject.addProperty(metricName, arr[currentIndex + 1]);
                currentIndex += 2;
            }

            // Add the subObject to the main object
            obj.add(subObjectName, subObject);

            // Move to the next subObject or exit if end of data
            while (currentIndex < arr.length && arr[currentIndex].isEmpty()) {
                currentIndex++;
            }
        }

        collector.collect(obj.toString());
    }
}
