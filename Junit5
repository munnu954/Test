import org.apache.flink.streaming.api.datastream.DataStream;
import org.json.JSONObject;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Assertions;

import java.io.IOException;
import java.util.Iterator;

public class CsvToJsonDRATest {

    private File draFile;
    private String jsonFirstRow;
    private String jsonSecondRow;
    private String jsonThirdRow;
    private String jsonFourthRow;
    private String jsonFifthRow;
    private DataStream<String> draJsonStream;
    private String fileName = "DRA";

    @BeforeEach
    public void setup() throws IOException {
        this.draFile = new File("src/test/resources/files/DRA.csv");
    }

    @Test
    public void validateConvertedDRAJsonRows() throws Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        final DataStream<String> stream = env.fromElements(Main.readCSVFile(this.draFile.toPath().toString()));
        this.draJsonStream = stream.flatMap(new CsvtoJsonDRAnTransformer(fileName));

        Iterator<String> iterator = this.draJsonStream.executeAndCollect();
        this.jsonFirstRow = iterator.next();
        this.jsonSecondRow = iterator.next();
        this.jsonThirdRow = iterator.next();
        this.jsonFourthRow = iterator.next();
        this.jsonFifthRow = iterator.next();

        validateJsonRow(this.jsonFirstRow);
        validateJsonRow(this.jsonSecondRow);
        validateJsonRow(this.jsonThirdRow);
        validateJsonRow(this.jsonFourthRow);
        validateJsonRow(this.jsonFifthRow);
    }

    private void validateJsonRow(String jsonRow) {
        JSONObject jsonResponse = new JSONObject(jsonRow);

        Assertions.assertEquals("Diameter Egress Transaction", jsonResponse.get("Group"));
        Assertions.assertEquals("SG", jsonResponse.get("ScopeType"));
        Assertions.assertEquals("301", jsonResponse.get("TxAnswerTimeoutMp"));
        Assertions.assertEquals("ALL", jsonResponse.get("Server"));
        Assertions.assertEquals("01/23/2024 18:11:13 UTC", jsonResponse.get("Start"));
        Assertions.assertEquals("Oracle Communications Diameter Signaling Router 8.6.0.1.0-96.15.0", jsonResponse.get("Product"));
        Assertions.assertEquals("204", jsonResponse.get("Count"));
        Assertions.assertEquals("0", jsonResponse.get("RxAnswerMsgQueueFullDiscard"));
        Assertions.assertEquals("2024-01-23 18:11:00 UTC", jsonResponse.get("Timestamp"));
        Assertions.assertEquals("HOSTNAME IN", jsonResponse.get("Match"));
        Assertions.assertEquals("MeasSimple", jsonResponse.get("ReportType"));
        Assertions.assertEquals("01/23/2024 19:13:30 UTC", jsonResponse.get("ReportDate"));
        Assertions.assertEquals("njbbs1f51mpA", jsonResponse.get("Scope"));
        Assertions.assertEquals("Diameter Egress Transaction", jsonResponse.get("ReportDescription"));
        Assertions.assertEquals("01/23/2024 19:11:13 UTC", jsonResponse.get("End"));
        Assertions.assertEquals("0:05", jsonResponse.get("Interval"));
    }
}