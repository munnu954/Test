import org.apache.flink.streaming.api.datastream.DataStream;
import org.json.JSONObject;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Assertions;

import java.io.IOException;
import java.util.Iterator;

public class CsvToJsonDRATest {

    private File draFile;
    private String jsonFirstRow;
    private DataStream<String> draJsonStream;
    private String fileName = "DRA";

    @BeforeEach
    public void setup() throws IOException {
        this.draFile = new File("src/test/resources/files/DRA.csv");
    }

    @Test
    public void testCsvToJsonTransformation() throws Exception {
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        final DataStream<String> stream = env.fromElements(Main.readCSVFile(this.draFile.toPath().toString()));
        this.draJsonStream = stream.flatMap(new CsvtoJsonDRAnTransformer(fileName));

        Iterator<String> iterator = this.draJsonStream.executeAndCollect();
        this.jsonFirstRow = iterator.next();

        JSONObject firstJson = new JSONObject(jsonFirstRow);

        Assertions.assertEquals("Diameter Egress Transaction", firstJson.get("Group"));
        Assertions.assertEquals("SG", firstJson.get("ScopeType"));
        Assertions.assertEquals("301", firstJson.get("TxAnswerTimeoutMp"));
        Assertions.assertEquals("ALL", firstJson.get("Server"));
        Assertions.assertEquals("01/23/2024 18:11:13 UTC", firstJson.get("Start"));
        Assertions.assertEquals("Oracle Communications Diameter Signaling Router 8.6.0.1.0-96.15.0", firstJson.get("Product"));
        Assertions.assertEquals("204", firstJson.get("Count"));
        Assertions.assertEquals("0", firstJson.get("RxAnswerMsgQueueFullDiscard"));
        Assertions.assertEquals("2024-01-23 18:11:00 UTC", firstJson.get("Timestamp"));
        Assertions.assertEquals("HOSTNAME IN", firstJson.get("Match"));
        Assertions.assertEquals("MeasSimple", firstJson.get("ReportType"));
        Assertions.assertEquals("01/23/2024 19:13:30 UTC", firstJson.get("ReportDate"));
        Assertions.assertEquals("njbbs1f51mpA", firstJson.get("Scope"));
        Assertions.assertEquals("Diameter Egress Transaction", firstJson.get("ReportDescription"));
        Assertions.assertEquals("01/23/2024 19:11:13 UTC", firstJson.get("End"));
        Assertions.assertEquals("0:05", firstJson.get("Interval"));
    }
}