@SpringBootTest
class FlinkApiControllerTest {

    @Autowired
    private FlinkApiController flinkApiController;
    
    @MockBean
    private RestTemplate restTemplate;
    
    // AC1: Jar file is not uploaded to flink cluster
    @Test
    void testJarFileNotUploadedToFlinkCluster() {
        String flinkJobJarid = "non_existent_custom-csy-data-transformer-0.0.1-SNAPSHOT-jar-with-dependencies.jar";
        String programArgs = "–input input –fileType csv –bootstarpServer localhost:9092 –Topic COLLECTION-OUTPUT";
        SpaceCollector collector = new SpaceCollector();
        collector.setInputFilePath("/path/to/input.csv");

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);

        JSONObject requestBody = new JSONObject();
        requestBody.put("programArgs", programArgs.replace("input", collector.getInputFilePath()));
        String jobSubmitUrl = "http://localhost:8081/jars/" + flinkJobJarid + "/run";

        HttpEntity<String> request = new HttpEntity<>(requestBody.toString(), headers);

        ResponseEntity<String> responseEntity = new ResponseEntity<>(HttpStatus.INTERNAL_SERVER_ERROR);
        
        given(restTemplate.postForEntity(jobSubmitUrl, request, String.class)).willReturn(responseEntity);

        // When
        String result = flinkApiController.triggerJob(collector, ".csv");

        // Then
        verify(restTemplate, times(1)).postForEntity(jobSubmitUrl, request, String.class);
        assertEquals("Job is not trigged", result);
    }

    // AC2: Non existent jar id passed to flink cluster
    @Test
    void testNonExistentJarIdPassedToFlinkCluster() {
        String flinkJobJarid = "non_existent_custom-csy-data-transformer-0.0.1-SNAPSHOT-jar-with-dependencies.jar";
        String programArgs = "–input input –fileType csv –bootstarpServer localhost:9092 –Topic COLLECTION-OUTPUT";
        SpaceCollector collector = new SpaceCollector();
        collector.setInputFilePath("/path/to/input.csv");
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);

        JSONObject requestBody = new JSONObject();
        requestBody.put("programArgs", programArgs.replace("input", collector.getInputFilePath()));
        String jobSubmitUrl = "http://localhost:8081/jars/" + flinkJobJarid + "/run";

        HttpEntity<String> request = new HttpEntity<>(requestBody.toString(), headers);

        ResponseEntity<String> responseEntity = new ResponseEntity<>(HttpStatus.NOT_FOUND);
        
        given(restTemplate.postForEntity(jobSubmitUrl, request, String.class)).willReturn(responseEntity);

        // When
        String result = flinkApiController.triggerJob(collector, ".csv");

        // Then
        verify(restTemplate, times(1)).postForEntity(jobSubmitUrl, request, String.class);
        assertEquals("Job is not trigged", result);
    }
}