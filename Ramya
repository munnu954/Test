import org.apache.flink.api.common.functions.FlatMapFunction;
import org.apache.flink.util.Collector;
import org.json.JSONObject;

public class CsvtoJsonConversion implements FlatMapFunction<String, String> {

    private String currentObjectName;
    private JSONObject jsonObject;

    @Override
    public void flatMap(String input, Collector<String> collector) throws Exception {
        String[] arr = input.split(",");

        if (arr.length > 2 && arr[2] != null && !arr[2].isEmpty()) {
            // New Object Name
            handleNewObject(arr);
        } else if (arr.length > 6 && arr[3] != null && !arr[3].isEmpty()) {
            // Min, Average, Max, CumulativeCounterValue section
            handleMinMaxSection(arr);
        } else if (arr.length > 1 && arr[0] != null && !arr[0].isEmpty()) {
            // Caller Data section
            handleCallerData(arr);
        }

        collector.collect(jsonObject.toString());
    }

    private void handleNewObject(String[] arr) {
        if (jsonObject != null) {
            // Save the completed object
            collector.collect(jsonObject.toString());
        }

        // Start a new JSON object
        currentObjectName = arr[2].trim();
        jsonObject = new JSONObject();
        jsonObject.put("ObjectName", currentObjectName);
    }

    private void handleMinMaxSection(String[] arr) {
        String metricName = arr[2].replaceAll("\\s+", ""); // Adjust based on your actual column name
        JSONObject metricsObject = new JSONObject();
        metricsObject.put("Min", arr[3].trim());
        metricsObject.put("Average", arr[4].trim());
        metricsObject.put("Max", arr[5].trim());
        metricsObject.put("CumulativeCounterValue", arr[6].trim());

        jsonObject.put(metricName, metricsObject);
    }

    private void handleCallerData(String[] arr) {
        // Caller Data section
        for (int i = 0; i < arr.length; i++) {
            String columnName = "AdditionalColumn" + i; // Adjust as needed
            jsonObject.put(columnName, arr[i].trim());
        }
    }
}
